<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.task.mapper.KanbanMapper">

    <select id="findProjectsByUserId" resultType="com.task.entity.Project">
        SELECT
            project_id AS projectId,
            project_name AS projectName,
            owner_user_id AS ownerUserId
        FROM t_project
        WHERE owner_user_id = #{userId}
    </select>

    <resultMap id="ListMap" type="com.task.entity.KanbanList">
        <id property="listId" column="list_id"/>
        <result property="listName" column="list_name"/>
        <result property="projectId" column="project_id"/>
        <result property="orderIndex" column="list_order"/>

        <collection property="cards" ofType="com.task.entity.Card">
            <id property="cardId" column="card_id"/>
            <result property="cardContent" column="card_content"/>
            <result property="listId" column="card_list_id"/>
            <result property="orderIndex" column="card_order"/>
        </collection>
    </resultMap>

    <select id="findListsByProjectId" resultMap="ListMap">
        SELECT
            l.list_id,
            l.list_name,
            l.project_id,
            l.order_index as list_order,
            c.card_id,
            c.card_content,
            c.list_id as card_list_id,
            c.order_index as card_order
        FROM t_list l
                 LEFT JOIN t_card c ON l.list_id = c.list_id
        WHERE l.project_id = #{projectId}
        ORDER BY l.order_index ASC, c.order_index ASC
    </select>

    <update id="updateCardList">
        UPDATE t_card
        SET list_id = #{listId}
        WHERE card_id = #{cardId}
    </update>

    <insert id="addCard" parameterType="com.task.entity.Card" useGeneratedKeys="true" keyProperty="cardId">
        INSERT INTO t_card (card_content, list_id, order_index)
        VALUES (
                   #{cardContent},
                   #{listId},
                   (SELECT IFNULL(MAX(order_index), 0) + 1 FROM t_card temp WHERE list_id = #{listId})
               )
    </insert>
    <insert id="addList" parameterType="com.task.entity.KanbanList" useGeneratedKeys="true" keyProperty="listId">
        INSERT INTO t_list (list_name, project_id, order_index)
        VALUES (
                   #{listName},
                   #{projectId},
                   (SELECT tmp.new_order FROM (
                                                  SELECT IFNULL(MAX(order_index), 0) + 1 AS new_order
                                                  FROM t_list
                                                  WHERE project_id = #{projectId}
                                              ) AS tmp)
               )
    </insert>

    <update id="updateListName">
        UPDATE t_list SET list_name = #{listName} WHERE list_id = #{listId}
    </update>

    <delete id="deleteCardsByListId">
        DELETE FROM t_card WHERE list_id = #{listId}
    </delete>

    <delete id="deleteList">
        DELETE FROM t_list WHERE list_id = #{listId}
    </delete>

    <insert id="addProject" parameterType="com.task.entity.Project" useGeneratedKeys="true" keyProperty="projectId">
        INSERT INTO t_project (project_name, owner_user_id)
        VALUES (#{projectName}, #{ownerUserId})
    </insert>

    <update id="updateProjectName">
        UPDATE t_project SET project_name = #{projectName} WHERE project_id = #{projectId}
    </update>

    <delete id="deleteCardsByProjectId">
        DELETE t_card FROM t_card
    INNER JOIN t_list ON t_card.list_id = t_list.list_id
    WHERE t_list.project_id = #{projectId}
    </delete>

    <delete id="deleteListsByProjectId">
        DELETE FROM t_list WHERE project_id = #{projectId}
    </delete>

    <delete id="deleteProject">
        DELETE FROM t_project WHERE project_id = #{projectId}
    </delete>

    <update id="moveAllCards">
        UPDATE t_card SET list_id = #{targetListId} WHERE list_id = #{sourceListId}
    </update>

    <select id="getProjectIdByListId" resultType="Integer">
        SELECT project_id FROM t_list WHERE list_id = #{listId}
    </select>

    <select id="getListIdByName" resultType="Integer">
        SELECT list_id FROM t_list
        WHERE project_id = #{projectId} AND list_name = #{listName}
            LIMIT 1
    </select>

</mapper>